{% extends "base.html" %}
{% load static %}


{% block content %}


    <section class="hero_section">
        <div class="container">
            <div class="hero_text_main">
                <h5>Instant quote <img src="{% static 'assets/imgs/stars.svg' %}" alt=""></h5>
                <h2>Get an Instant Quote for Your 3D Print</h2>
                <p>Upload your model, select materials and options, get instant pricing with detailed breakdown</p>
            </div>
        </div>
    </section>

    <section class="quote_section">
        <div class="container">
            <div class="quote_multistep_form_main">
                <div class="steps">
                      <div class="step">
                        <div class="step_circle">2</div>
                        <div class="step_text">
                           <h6>Upload File</h6>
                            <p>STL, OBJ, 3MF</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step_circle">2</div>
                        <div class="step_text">
                            <h6>Configure</h6>
                            <p>Material & Settings</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step_circle">3</div>
                        <div class="step_text">
                            <h6>Quote & Order</h6>
                            <p>Review & Purchase</p>
                        </div>
                    </div>
                </div>

                <div class="form-step active">
                    <div class="form_step_content_main">
                        <div class="form_step_cont_title">
                            <h2><span>Step 1:</span> Upload Your 3D File</h2>
                            <p>Upload your 3D model and we'll analyze it instantly to provide accurate pricing</p>
                        </div>
                        <div class="form_cont_step1_upload_file" id="dropzone">
                            <div class="dropzone-content">
                                <img src="{% static 'assets/imgs/export.svg' %}" alt="Upload Icon" class="upload-icon">
                                <h4>Drag and drop your file here</h4>
                                <p>or click to browse your computer</p>
                                <label class="browse-btn mt-3">
                                    Browse File <img src="{% static 'assets/imgs/clipboardtext.svg' %}" alt="">
                                    <input type="file" id="file_upload" hidden>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-step">
                    <div class="form_step_content_main">
                        <div class="form_step_cont_title">
                            <h2><span>Step 2:</span> Configure Your Print Settings</h2>
                            <p>Choose your material, quality settings, and finishing options to customize your 3D print</p>
                        </div>
                        <div class="form_cont_step2_inner_main">
                             <div class="row">
                                <div class="col-lg-6 col-md-6 col-sm-12">
                                    <div class="form_cont_step_inputs">
                                        <h5>3D Printing Technology</h5>
                                        {% comment %} <select name="" id="" class="form-select">
                                            <option value="option1" selected>FFF (Fused Filament Fabrication)</option>
                                            <option value="option2">FFF (Fused Filament Fabrication) 2</option>
                                            <option value="option3">FFF (Fused Filament Fabrication) 3</option>
                                        </select> {% endcomment %}
                                        <select id="unit" name="unit" class="form-select" required>
                                            <option value="mm">Millimeters (mm)</option>
                                            <option value="cm">Centimeters (cm)</option>
                                            <option value="m">Meters (m)</option>
                                          </select>
                                        <p>Most common and cost-effective for prototypes</p>
                                    </div>
                                </div>
                                <div class="col-lg-6 col-md-6 col-sm-12">
                                    <div class="form_cont_step_inputs">
                                        <h5>3D Printing Technology</h5>
                                        <input type="number" id="num_pieces" class="form-select" name="num_pieces" min="1" max="65535" value="1" required />
                                            {% comment %} 
                                        <select name="" id="" class="form-select">
                                            <option value="option1" selected>Standard (0.2mm)</option>
                                            <option value="option2">Standard (0.3mm) </option>
                                            <option value="option3">Standard (0.4mm) </option>
                                        </select> {% endcomment %}
                                    </div>
                                </div>
                             </div>
                             <div class="material_selection_cards_main">
                                <div class="step_title">
                                    <h4>Material Selection</h4>
                                </div>
                                <div class="row">
                                    <div class="col-lg-4 col-md-6 col-sm-12">
                                        <div class="material_sel_card_body_div ms_card_active" data-material="PLA">
                                            <div class="material_sel_card_txt1">
                                                <div class="material_sel_card_txt1_inner">
                                                    <img src="{% static 'assets/imgs/ms1.svg' %}" alt=".">
                                                    <div>
                                                        <h5>PLA (Polylactic Acid)</h5>
                                                        <p>Easy to print, biodegradable</p>
                                                    </div>
                                                </div>
                                                <span>$0.08/g</span>
                                            </div>
                                            <h6>Perfect for prototypes, decorative items, and low-stress applications. Print temp: 190-220°C</h6>
                                        </div>
                                    </div>
                                    <div class="col-lg-4 col-md-6 col-sm-12">
                                        <div class="material_sel_card_body_div" data-material="CF">
                                            <div class="material_sel_card_txt1">
                                                <div class="material_sel_card_txt1_inner">
                                                    <img src="{% static 'assets/imgs/ms2.svg' %}" alt=".">
                                                    <div>
                                                        <h5>ABS</h5>
                                                        <p>Strong, heat resistant</p>
                                                    </div>
                                                </div>
                                                <span>$0.12/g</span>
                                            </div>
                                            <h6>Ideal for functional parts, automotive components. Print temp: 220-250°C</h6>
                                        </div>
                                    </div>
                                    <div class="col-lg-4 col-md-6 col-sm-12">
                                        <div class="material_sel_card_body_div" data-material="PETG">
                                            <div class="material_sel_card_txt1">
                                                <div class="material_sel_card_txt1_inner">
                                                    <img src="{% static 'assets/imgs/ms3.svg' %}" alt=".">
                                                    <div>
                                                        <h5>PETG </h5>
                                                        <p>Chemical resistant, clear</p>
                                                    </div>
                                                </div>
                                                <span>$0.15/g</span>
                                            </div>
                                            <h6>Great for food containers, medical devices. Print temp: 220-250°C</h6>
                                        </div>
                                    </div>
                                </div>
                             </div>
                             <div class="print_quality_cards_main">
                                <div class="step_title">
                                    <h4>Print Quality</h4>
                                </div>
                                <div class="print_quality_cards_inner">
                                    <div class="print_quality_card_body pq_card_active">
                                        <h6>Draft</h6>
                                        <p>0.3mm layers</p>
                                        <span>Fastest</span>
                                    </div>
                                    <div class="print_quality_card_body">
                                        <h6>Standard</h6>
                                        <p>0.2mm layers</p>
                                        <span>Balanced</span>
                                    </div>
                                    <div class="print_quality_card_body">
                                        <h6>High</h6>
                                        <p>0.1mm layers</p>
                                        <span>Finest</span>
                                    </div>
                                </div>
                             </div>
                             <div class="infill_density_cards_main">
                                <div class="step_title">
                                    <h4>Infill Density</h4>
                                </div>
                                <div class="infill_den_progressbar_main">
                                    <div class="infill_den_prog_txt1">
                                        <h6>Density: <span id="output">25%</span> </h6>
                                        <p>Standard</p>
                                    </div>
                                    <div class="slider-wrapper">
                                        <input type="range" min="0" max="100" step="1" value="25" class="range-slider" id="slider">
                                        <div class="range-marks">
                                            <span>10%</span>
                                            <span>25%</span>
                                            <span>50%</span>
                                            <span>100%</span>
                                        </div>
                                    </div>
                                </div>
                             </div>
                             <div class="color_selection_cards_main">
                                <div class="step_title">
                                    <h4>Color Selection</h4>
                                </div>
                                <div class="color_sel_inner" id="colorOptions">
                                    <div class="color-box colorwhite active" data-color="white"></div>
                                    <div class="color-box colorgray" data-color="gray"></div>
                                    <div class="color-box colorpink" data-color="pink"></div>
                                    <div class="color-box colorblue" data-color="blue"></div>
                                    <div class="color-box colorgreen" data-color="green"></div>
                                    <div class="color-box coloryellow" data-color="yellow"></div>
                                    <div class="color-box colororange" data-color="orange"></div>
                                    <div class="color-box colorpurple" data-color="purple"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-step">
                    <div class="form_step_content_main">
                        <div class="form_step_cont_title">
                            <h2><span>Step 3:</span> Quote & Order</h2>
                            <p>Review your configuration and pricing details before placing your order</p>
                        </div>
                        <div class="form_step_cont_cards_main">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="step3_order_summary_card">
                                                <h2 class="step3_cards_title">Order Summary</h2>
                                                <div class="ord_sum_pro">
                                                    <img src="{% static 'assets/imgs/ors.svg' %}" alt="">
                                                    <div>
                                                        <h5 id="image_name">sample-model.stl</h5>
                                                        <p id="image_size">2.5 MB</p>
                                                </div>
                                            </div>
                                            <div class="step3_os_text_inner">
                                                <p>Technology:</p>
                                                <h6 id="quote_material">FFF</h6>
                                            </div>
                                            <div class="step3_os_text_inner">
                                                <p>Material:</p>
                                                <h6 id="quote_material">PLA</h6>
                                            </div>
                                            <div class="step3_os_text_inner">
                                                <p>Quality:</p>
                                                <h6>Standard</h6>
                                            </div>
                                            <div class="step3_os_text_inner">
                                                <p>Infill:</p>
                                                <h6>50%</h6>
                                            </div>
                                            <div class="step3_os_text_inner">
                                                <p>Color:</p>
                                                <h6>Natural</h6>
                                            </div>
                                            <div class="step3_os_text_inner">
                                                <p>Quantity:</p>
                                                <h6><span id="quote_pieces">2</span> pieces</h6>
                                            </div>
                                            <div class="step3_os_text_inner">
                                                <p>Post-Processing:</p>
                                                <h6><span id="quote_pieces">2</span> pieces</h6>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="step3_order_summary_card">
                                                <h2 class="step3_cards_title">Price Breakdown</h2>
                                                <div class="step3_os_text_main">
                                                    <div class="step3_os_text_inner">
                                                        <p>Material Cost</p>
                                                        <h6>$50.00</h6>
                                                    </div>
                                                    <div class="step3_os_text_inner">
                                                        <p>Printing Cost</p>
                                                        <h6>$50.00</h6>
                                                    </div>
                                                    <div class="step3_os_last_text_inner">
                                                        <h6>Subtotal</h6>
                                                        <p id="quote_price">$160.00</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="row">
                                        <div class="col-12">
                                        <div class="step3_order_summary_card">
                                            <h2 class="step3_cards_title">Delivery Information</h2>
                                            <div class="step3_DI_text_main">
                                                <div class="step3_DI_text_inner DI_txt_Dot">
                                                    <h6>Express Delivery</h6>
                                                    <p>5-7 business days (Free)</p>
                                                </div>
                                            </div>
                                            <div class="step3_DI_text_main">
                                                <div class="step3_DI_text_inner">
                                                    <h6>Standard Delivery</h6>
                                                    <p>2-3 business days (+$25)</p>
                                                </div>
                                            </div>
                                            <div class="step3_DI_text_main">
                                                <div class="step3_DI_text_inner">
                                                    <h6>Overnight Delivery</h6>
                                                    <p>Next business day (+$50)</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-12">
                                            <div class="step3_order_summary_card pb-5">
                                            <h2 class="step3_cards_title">Estimated Timeline</h2>
                                            <div class="step3_ET_text_main">
                                                <div class="step3_ET_text_inner">
                                                    <h6>File Processing</h6>
                                                    <p>1-2 hours</p>
                                                </div>
                                            </div>
                                            <div class="step3_ET_text_main">
                                                <div class="step3_ET_text_inner">
                                                    <h6>3D Printing</h6>
                                                    <p>2-3 days</p>
                                                </div>
                                            </div>
                                            <div class="step3_ET_text_main">
                                                <div class="step3_ET_text_inner">
                                                    <h6>Post-Processing</h6>
                                                    <p>1-2 days</p>
                                                </div>
                                            </div>
                                            <div class="step3_ET_text_main">
                                                <div class="step3_ET_text_inner">
                                                    <h6>Quality Check & Shipping</h6>
                                                    <p>1 day</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <div class="navigation-buttons">
                    <button id="prevBtn" disabled>Back</button>
                    <button id="nextBtn">Next</button>
                    <div id="form_last_btns" style="display: none;">
                        <button id="submitBtn" class="step_active_btn">Add to Cart - $160.00</button>
                        <button type="button">Save Quote</button>
                    </div>
                </div> 
            </div>
          
        </div>
        <div class="container">
              <div class="file_format_main">
                <h3>Supported File Formats</h3>
                <div class="file_format_inner">
                    <div class="fileformat">
                        <button type="button">STL</button>
                        <p>Most common</p>
                    </div>
                    <div class="fileformat">
                        <button type="button">OBJ</button>
                        <p>With textures </p>
                    </div>
                    <div class="fileformat">
                        <button type="button">3MF</button>
                        <p>Microsoft 3D</p>
                    </div>
                    <div class="fileformat">
                        <button type="button">PLY </button>
                        <p>Point cloud</p>
                    </div>
                </div>
            </div>
            <div class="file_format_bottom_text">
                <p>Maximum file size: 100MB • Recommended: STL or 3MF</p>
                <a href="#">View Upload Guidelines</a>
            </div>
            <div class="file_format_bottom_text2">
                <div class="file_format_bottom_text2_inner">
                    <img src="{% static 'assets/imgs/ffb1.svg' %}" alt="">
                    <p>Professional Design</p>
                </div>
                <div class="file_format_bottom_text2_inner">
                    <img src="{% static 'assets/imgs/ffb2.svg' %}" alt="">
                    <p>Secure & Confidential</p>
                </div>
                <div class="file_format_bottom_text2_inner">
                    <img src="{% static 'assets/imgs/ffb3.svg' %}" alt="">
                    <p>24-48hr Response</p>
                </div>
            </div>
        </div>
    </section>


{% endblock content %}

{% block js %}

<script>
  const steps = document.querySelectorAll(".step");
  const formSteps = document.querySelectorAll(".form-step");
  const nextBtn = document.getElementById("nextBtn");
  const prevBtn = document.getElementById("prevBtn");
  const submitBtn = document.getElementById("submitBtn");
  const lastBtns = document.getElementById("form_last_btns");

  let currentStep = 0;
  let quoteData = null;

function formatFileSize(bytes) {
  if (bytes >= 1024 * 1024) {
    return (bytes / (1024 * 1024)).toFixed(2) + " MB";
  } else {
    return (bytes / 1024).toFixed(2) + " KB";
  }
}

function updateStep3Content(data) {
  document.getElementById('quote_price').textContent = `$${data.price}`;
  document.getElementById('quote_material').textContent = data.material;
  document.getElementById('quote_pieces').textContent = data.num_pieces;
  document.getElementById('image_name').textContent = data.file_name;

  const readableSize = formatFileSize(data.file_size);
  document.getElementById('image_size').textContent = readableSize;
}



  async function submitQuoteRequest() {
    try {
      // 1. Get required fields
      const unit = document.getElementById('unit')?.value;
      const numPieces = document.getElementById('num_pieces')?.value;
      const fileInput = document.getElementById('file_upload');
      const file = fileInput?.files?.[0];
  
      // 2. Get selected material from data-material
      const activeMaterialCard = document.querySelector('.ms_card_active');
      const selectedMaterial = activeMaterialCard?.dataset?.material;
  
      // 3. Validate inputs
    //   if (!unit || !numPieces || !selectedMaterial || !file) {
    //     alert("❗ Please fill in all required fields and select a file.");
    //     return;
    //   }
  
      // 4. Prepare payload
      const json_payload = {
        unit: unit,
        material: selectedMaterial.toUpperCase(),
        num_pieces: parseInt(numPieces)
      };
  
      const formData = new FormData();
      formData.append("json_payload", JSON.stringify(json_payload));
      formData.append("file_upload", file);
      console.log(formData)
  
      // 5. Send request to Django view
      const response = await fetch("/test/", {
        method: "POST",
        body: formData
      });
  
      const result = await response.json();
      console.log(result)
      
  
      // 6. Handle response
      if (response.ok) {
        alert(`✅ Estimated Price: $${result.price}`);
        quoteData = {
            ...result,                     // keeps API data (like price)
            unit: unit,                   // from user input
            material: selectedMaterial,   // from card selection
            num_pieces: parseInt(numPieces), // from user input
            file_name: file?.name,        // name of uploaded file
            file_size:file?.size
        };
        // quoteData = result; // Save for later use
        console.log(`the quote data is ${quoteData}`)
        updateStep3Content(quoteData); // Render in Step 3
        return true;
        // Optionally: render price in UI instead of alert
      } else {
        console.error("❌ Quote API error:", result);
        alert("❌ Failed to get quote: " + (result.error || "Unknown error"));
      }
    } catch (err) {
      console.error("❌ Request failed:", err);
      alert("❌ Something went wrong. Please try again.");
    }
  }
  function updateForm() {

    formSteps.forEach((form, i) => {
      form.classList.remove("active");
      setTimeout(() => {
        if (i === currentStep) form.classList.add("active");
      }, 10);
    });

    steps.forEach((step, i) => {
      step.classList.remove("active", "completed");
      if (i < currentStep) {
        step.classList.add("completed");
      } else if (i === currentStep) {
        step.classList.add("active");
      }
    });

    prevBtn.disabled = currentStep === 0;

    // Show/Hide Next & Submit buttons 
    if (currentStep === steps.length - 1) {
      nextBtn.style.display = "none";
      lastBtns.style.display = "flex";
    } else {
      nextBtn.style.display = "flex";
      lastBtns.style.display = "none";
    }
  }

  nextBtn.addEventListener("click", () => {
    if (currentStep < formSteps.length - 1) {
       console.log(currentStep)
      if (currentStep == 1){
        submitQuoteRequest(); 
      }
      currentStep++;
      updateForm();
    }
  });

  prevBtn.addEventListener("click", () => {
    if (currentStep > 0) {
      currentStep--;
      updateForm();
    }
  });

  submitBtn.addEventListener("click", () => {
    alert("✅ Form Submitted!");
    // You can also submit the actual form here
  });

  updateForm();
</script>

<script>
  const dropzone = document.getElementById('dropzone');

  dropzone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropzone.classList.add('dragover');
  });

  dropzone.addEventListener('dragleave', () => {
    dropzone.classList.remove('dragover');
  });

  dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.classList.remove('dragover');
    const files = e.dataTransfer.files;
    // Handle files here...
    alert(`You dropped ${files.length} file(s)`);
  });

  document.getElementById("file_upload").addEventListener("change", function () {
    alert(`You selected ${this.files.length} file(s)`);
  });
</script>

<script>
  const cards = document.querySelectorAll('.material_sel_card_body_div');

  cards.forEach(card => {
    card.addEventListener('click', () => {
      // Remove active class from all cards
      cards.forEach(c => c.classList.remove('ms_card_active'));

      // Add active class to the clicked card
      card.classList.add('ms_card_active');
    });
  });
</script>

<script>
  const pqcards = document.querySelectorAll('.print_quality_card_body');

  pqcards.forEach(card => {
    card.addEventListener('click', () => {
      // Remove active class from all cards
      pqcards.forEach(c => c.classList.remove('pq_card_active'));

      // Add active class to the clicked card
      card.classList.add('pq_card_active');
    });
  });
</script>

<script>
    const slider = document.getElementById("slider");
    const output = document.getElementById("output");

    function updateSlider(value) {
      const min = slider.min;
      const max = slider.max;
      const percent = ((value - min) / (max - min)) * 100;

      // Update background fill
      slider.style.background = `linear-gradient(to right, #D7531B 0%, #D7531B ${percent}%, #e5e5e5 ${percent}%, #e5e5e5 100%)`;

      // Update percentage output
      output.textContent = `${Math.round(value)}%`;
    }

    // Initialize
    updateSlider(slider.value);

    // Update on input
    slider.addEventListener("input", function () {
      updateSlider(this.value);
    });
</script>

<script>
    const colorBoxes = document.querySelectorAll('.color-box');

    colorBoxes.forEach(box => {
      box.addEventListener('click', () => {
        // Remove active from all
        colorBoxes.forEach(b => b.classList.remove('active'));
        // Add to clicked
        box.classList.add('active');

        // Optional: Get the selected color value
        const selectedColor = box.getAttribute('data-color');
        console.log('Selected color:', selectedColor);
      });
    });
</script>


{% endblock js %}